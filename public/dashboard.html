<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Tesla Copiloto | Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTILOS BASE (Sobrescriben styles.css si hay conflicto con mi otro archivo) --- */
        body { font-family: 'Roboto', sans-serif; background-color: #111; color: #fff; margin: 0; }
        .dashboard-container { padding: 2rem; max-width: 1400px; margin: 0 auto; }
        
        /* HEADER */
        .main-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background-color: #000; border-bottom: 1px solid #333; }

        /* PANEL ADMIN */
        .admin-panel { background-color: #1c1c1c; padding: 25px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #333; display: none; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .input-group { display: flex; gap: 15px; align-items: center; }

        /* INPUTS & BOTONES */
        .tesla-input { padding: 12px; border-radius: 4px; border: 1px solid #444; background: #000; color: #fff; outline: none; }
        .btn-crear { padding: 12px 25px; background: #e82127; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        .btn-user-add { background: transparent; border: 1px solid #3b82f6; color: #3b82f6; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        .btn-save-manual { background-color: #10b981; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-top: 5px; }

        /* TABLA (Solo Desktop) */
        .table-container { background-color: #181818; border-radius: 8px; overflow: hidden; border: 1px solid #333; margin-top: 20px; }
        .tasks-table { width: 100%; border-collapse: collapse; }
        .tasks-table th, .tasks-table td { padding: 15px; text-align: left; border-bottom: 1px solid #2a2a2a; }
        .tasks-table th { background-color: #222; color: #aaa; text-transform: uppercase; font-size: 0.85rem; }

        /* UI ELEMENTS */
        .user-badge { display: flex; align-items: center; gap: 8px; background: #333; padding: 5px 10px; border-radius: 20px; width: fit-content; }
        .avatar-circle { width: 24px; height: 24px; background: #666; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 0.7rem; font-weight: bold; }
        .status-select { padding: 5px; border-radius: 15px; background: #000; color: #fff; border: 1px solid #444; }

        /* TARJETAS MÃ“VILES (Ocultas por defecto en Desktop) */
        .mobile-cards { display: none; } 

        /* MODALES */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 9999; display: none; }
        .modal-box { background: #1c1c1c; padding: 30px; border-radius: 12px; border: 1px solid #333; width: 90%; max-width: 450px; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        .btn-cancel { background: transparent; border: 1px solid #666; color: #ccc; padding: 10px; border-radius: 4px; cursor: pointer; flex: 1; }
        .btn-save { background: #e82127; border: none; color: white; padding: 10px; border-radius: 4px; cursor: pointer; flex: 1; }

        @media (max-width: 768px) {
            .dashboard-container { padding: 15px; }
            
            /* 1. Ocultar tabla, MOSTRAR TARJETAS (Forzado) */
            .table-container, .tasks-table { display: none !important; }
            
            .mobile-cards { 
                display: flex !important; /* !important para ganar a cualquier otra regla */
                flex-direction: column; 
                gap: 15px; 
                margin-top: 20px;
                padding-bottom: 50px; /* Espacio al final para poder hacer scroll */
            }

            /* Estilo de cada tarjeta */
            .task-card {
                background-color: #1c1c1c;
                border: 1px solid #333;
                border-radius: 8px;
                padding: 15px;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            /* 2. Ajustar Panel Admin para que no ocupe tanto espacio */
            .admin-panel { padding: 15px; margin-bottom: 20px; }
            .panel-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .input-group { flex-direction: column; width: 100%; }
            .tesla-input, .btn-crear, .btn-user-add { width: 100%; box-sizing: border-box; }
            
            /* Textos mÃ¡s legibles */
            h3 { font-size: 1.1rem; }
            p { font-size: 0.9rem; }
        }
    </style>
</head>
<body class="tesla-app-bg">

    <header class="main-header">
        <div style="display: flex; align-items: center; gap: 10px;">
            <img src="img/logo.png" alt="Tesla" style="height: 18px;">
            <span style="border-left: 1px solid #444; padding-left: 10px; font-size: 0.9rem;">Copiloto</span>
        </div>
        <button onclick="logout()" style="background:none; border:1px solid #444; color:#fff; padding: 5px 12px; border-radius:4px; font-size:0.8rem;">Salir</button>
    </header>

    <main class="dashboard-container">
        <h2 id="greeting" style="font-size: 1.2rem; margin-bottom: 20px;">Bienvenido</h2>
        
        <div id="admin-panel" class="admin-panel">
            <div class="panel-header">
                <h3 style="margin:0;">+ Nueva Tarea</h3>
                <button onclick="abrirModalUsuario()" class="btn-user-add">ðŸ‘¤ Crear Usuario</button>
            </div>
            <div class="input-group">
                <input type="text" id="desc-tarea" class="tesla-input input-desc" placeholder="DescripciÃ³n...">
                <select id="user-tarea" class="tesla-input input-user">
                    <option value="" disabled selected>Asignar a...</option>
                </select>
                <button onclick="crearTarea()" class="btn-crear">Crear</button>
            </div>
        </div>

        <div class="table-container">
            <table class="tasks-table">
                <thead>
                    <tr>
                        <th width="35%">ID / DescripciÃ³n</th>
                        <th>Inicio</th>
                        <th>Fin</th>
                        <th>Asignado A</th>
                        <th>Estatus</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="lista-tareas"></tbody>
            </table>
        </div>

        <div id="mobile-cards" class="mobile-cards">
            </div>

    </main>

    <div id="modal-editar" class="modal-overlay">
        <div class="modal-box">
            <h3>Editar Tarea</h3>
            <label>DescripciÃ³n:</label><input type="text" id="edit-desc" class="tesla-input" style="width:100%;">
            <label>Asignado:</label><select id="edit-user" class="tesla-input" style="width:100%;"></select>
            <input type="hidden" id="edit-id">
            <div class="modal-buttons">
                <button onclick="cerrarModalEditar()" class="btn-cancel">Cancelar</button>
                <button onclick="intentarGuardar()" class="btn-save">Guardar</button>
            </div>
        </div>
    </div>

    <div id="modal-usuario" class="modal-overlay">
        <div class="modal-box">
            <h3>Nuevo Usuario</h3>
            <input type="text" id="reg-name" class="tesla-input" placeholder="Nombre" style="width:100%; margin-bottom:10px;">
            <input type="text" id="reg-username" class="tesla-input" placeholder="Usuario" style="width:100%; margin-bottom:10px;">
            <input type="password" id="reg-password" class="tesla-input" placeholder="ContraseÃ±a" style="width:100%; margin-bottom:10px;">
            <select id="reg-role" class="tesla-input" style="width:100%; margin-bottom:10px;">
                <option value="user">Empleado</option>
                <option value="admin">Admin</option>
            </select>
            <div class="modal-buttons">
                <button onclick="cerrarModalUsuario()" class="btn-cancel">Cancelar</button>
                <button onclick="registrarUsuario()" class="btn-save">Registrar</button>
            </div>
        </div>
    </div>

    <div id="modal-sistema" class="modal-overlay">
        <div class="modal-box" style="text-align: center;">
            <h3 id="sys-title">Mensaje</h3>
            <p id="sys-msg" style="color:#ccc;"></p>
            <div class="modal-buttons" id="sys-btns"></div>
        </div>
    </div>

    <script>
        const API = 'http://localhost:3000/api';
        const token = localStorage.getItem('teslaToken');
        const role = localStorage.getItem('teslaRole');
        const myName = localStorage.getItem('teslaName');
        let tareasGlobales = [];
        let accionPendiente = null;

        if (!token) window.location.href = 'login.html';
        document.getElementById('greeting').innerText = `Panel: ${myName} (${role === 'admin' ? 'ADMIN' : 'USER'})`;
        
        if (role === 'admin') {
            document.getElementById('admin-panel').style.display = 'block';
            cargarUsuariosSelect();
        }

        // --- RENDERIZADO PRINCIPAL ---
        async function cargar() {
            try {
                const res = await fetch(`${API}/tareas`, { headers: { 'Authorization': `Bearer ${token}` } });
                if(res.ok) {
                    tareasGlobales = await res.json();
                    render(tareasGlobales);
                }
            } catch(e) { console.error(e); }
        }

        function render(tareas) {
            const tbody = document.getElementById('lista-tareas');
            const mobile = document.getElementById('mobile-cards');
            tbody.innerHTML = ''; 
            mobile.innerHTML = '';

            // Si no hay tareas, mostrar mensaje en mÃ³vil
            if(tareas.length === 0) {
                mobile.innerHTML = '<p style="text-align:center; color:#666;">No hay tareas asignadas.</p>';
                return;
            }
            
            tareas.forEach(t => {
                const initUser = t.assignedTo ? t.assignedTo[0].toUpperCase() : '?';
                const fechaFin = t.completedAt ? `<span style="color:#10b981;">${t.completedAt}</span>` : '-';

                // Determinar acciones segÃºn rol
                let accionesDesktop = '';
                let accionesMobile = '';
                let selectAttributes = '';

                if (role === 'admin') {
                    // ADMIN: Botones de editar/borrar
                    accionesDesktop = `
                        <button onclick="abrirModalEditar(${t.id})" style="color:#3b82f6; background:none; border:none; cursor:pointer; font-size:1.1rem;">âœŽ</button>
                        <button onclick="preguntaBorrar(${t.id})" style="color:#ef4444; background:none; border:none; cursor:pointer; font-size:1.1rem;">âœ–</button>`;
                    accionesMobile = accionesDesktop;
                    selectAttributes = `onchange="cambiarStatus(${t.id}, this.value)"`;
                } else {
                    // USER: BotÃ³n de guardar
                    accionesDesktop = `<button onclick="guardarEstatusManual(${t.id})" class="btn-save-manual">ðŸ’¾</button>`;
                    accionesMobile = `<button onclick="guardarEstatusManual(${t.id})" class="btn-save-manual" style="width:100%;">ðŸ’¾ Guardar Cambios</button>`;
                    selectAttributes = `id="status-${t.id}"`;
                }

                // 1. FILA DE TABLA (PC)
                tbody.innerHTML += `
                    <tr>
                        <td><small style="color:#666; font-family:monospace;">#${t.id}</small><br><b>${t.title}</b></td>
                        <td style="color:#888">${t.createdAt}</td>
                        <td>${fechaFin}</td>
                        <td><div class="user-badge"><div class="avatar-circle">${initUser}</div>${t.assignedTo}</div></td>
                        <td>
                            <select ${selectAttributes} class="status-select" style="border-color:${getColor(t.status)}; color:${getColor(t.status)}">
                                <option value="Pendiente" ${t.status=='Pendiente'?'selected':''}>Pendiente</option>
                                <option value="En Proceso" ${t.status=='En Proceso'?'selected':''}>En Proceso</option>
                                <option value="Completada" ${t.status=='Completada'?'selected':''}>Completada</option>
                            </select>
                        </td>
                        <td>${accionesDesktop}</td>
                    </tr>`;
                
                // 2. TARJETA CELULAR - 
                mobile.innerHTML += `
                    <div class="task-card">
                        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:10px;">
                            <span style="font-family:monospace; color:#666;">#${t.id}</span>
                            <div>${role === 'admin' ? accionesMobile : ''}</div>
                        </div>
                        
                        <h3 style="margin:0; font-size:1.1rem; color:#fff;">${t.title}</h3>
                        
                        <div style="font-size:0.9rem; color:#ccc; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div><span style="color:#666;">Inicio:</span><br>${t.createdAt}</div>
                            <div><span style="color:#666;">Fin:</span><br>${fechaFin}</div>
                            <div style="grid-column: span 2;">
                                <span style="color:#666;">Asignado:</span>
                                <div class="user-badge" style="display:inline-flex; margin-left:5px;">${t.assignedTo}</div>
                            </div>
                        </div>

                        <div style="margin-top:10px;">
                            <label style="color:#666; font-size:0.8rem;">Estatus:</label>
                            <select ${selectAttributes} class="status-select" style="width:100%; margin-top:5px; padding:10px; border-color:${getColor(t.status)}; color:${getColor(t.status)}">
                                <option value="Pendiente" ${t.status=='Pendiente'?'selected':''}>Pendiente</option>
                                <option value="En Proceso" ${t.status=='En Proceso'?'selected':''}>En Proceso</option>
                                <option value="Completada" ${t.status=='Completada'?'selected':''}>Completada</option>
                            </select>
                        </div>

                        ${role !== 'admin' ? `<div style="margin-top:10px;">${accionesMobile}</div>` : ''}
                    </div>`;
            });
        }

        // --- UI & LOGICA ---
        const ui = {
            alertar: (t, m) => { document.getElementById('sys-title').innerText=t; document.getElementById('sys-msg').innerText=m; document.getElementById('sys-btns').innerHTML=`<button onclick="ui.cerrar()" class="btn-save">OK</button>`; document.getElementById('modal-sistema').style.display='flex'; },
            confirmar: (t, m, cb) => { document.getElementById('sys-title').innerText=t; document.getElementById('sys-msg').innerText=m; accionPendiente=cb; document.getElementById('sys-btns').innerHTML=`<button onclick="ui.cerrar()" class="btn-cancel">Cancelar</button><button onclick="ui.ejecutar()" class="btn-save">Si</button>`; document.getElementById('modal-sistema').style.display='flex'; },
            cerrar: () => { document.getElementById('modal-sistema').style.display='none'; accionPendiente=null; },
            ejecutar: () => { if(accionPendiente) accionPendiente(); ui.cerrar(); }
        };

        // Funciones CRUD
        async function guardarEstatusManual(id) {
            const nuevoStatus = document.getElementById(`status-${id}`).value;
            ui.confirmar("Â¿Guardar?", `Cambiar a: ${nuevoStatus}`, async () => {
                await fetch(`${API}/tareas/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ status: nuevoStatus }) });
                cargar();
            });
        }
        async function cambiarStatus(id, st) { await fetch(`${API}/tareas/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ status: st }) }); cargar(); }
        async function crearTarea() {
            const desc = document.getElementById('desc-tarea').value; const user = document.getElementById('user-tarea').value;
            if(!desc || !user) return ui.alertar("Error", "Faltan datos");
            await fetch(`${API}/tareas`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ title: desc, assignedTo: user, assignmentArea: "General" }) });
            document.getElementById('desc-tarea').value=''; cargar();
        }
        function preguntaBorrar(id) { ui.confirmar("Â¿Borrar?", "Se eliminarÃ¡ permanentemente.", async () => { await fetch(`${API}/tareas/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } }); cargar(); }); }
        
        // Usuarios y Modales
        async function cargarUsuariosSelect() {
            try { const res = await fetch(`${API}/users`, { headers: { 'Authorization': `Bearer ${token}` } }); if(res.ok) { const users = await res.json(); const opts = '<option value="" disabled selected>Asignar...</option>' + users.map(u=>`<option value="${u.name}">${u.name}</option>`).join(''); document.getElementById('user-tarea').innerHTML=opts; document.getElementById('edit-user').innerHTML=opts; } } catch(e){}
        }
        function abrirModalEditar(id) { const t=tareasGlobales.find(x=>x.id===id); if(t){ document.getElementById('edit-id').value=id; document.getElementById('edit-desc').value=t.title; document.getElementById('edit-user').value=t.assignedTo; document.getElementById('modal-editar').style.display='flex'; } }
        function cerrarModalEditar() { document.getElementById('modal-editar').style.display='none'; }
        function intentarGuardar() { ui.confirmar("Â¿Guardar?", "Confirmar ediciÃ³n", async()=>{ const id=document.getElementById('edit-id').value; const t=document.getElementById('edit-desc').value; const u=document.getElementById('edit-user').value; await fetch(`${API}/tareas/${id}`, { method:'PUT', headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`}, body:JSON.stringify({title:t, assignedTo:u}) }); cerrarModalEditar(); cargar(); }); }
        
        function abrirModalUsuario(){ document.getElementById('reg-name').value=''; document.getElementById('reg-username').value=''; document.getElementById('reg-password').value=''; document.getElementById('modal-usuario').style.display='flex'; }
        function cerrarModalUsuario(){ document.getElementById('modal-usuario').style.display='none'; }
        async function registrarUsuario(){ const n=document.getElementById('reg-name').value; const u=document.getElementById('reg-username').value; const p=document.getElementById('reg-password').value; const r=document.getElementById('reg-role').value; if(!n||!u||!p) return ui.alertar("Error","Faltan datos"); const res=await fetch(`${API}/register`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n,username:u,password:p,role:r})}); if(res.ok){ ui.alertar("Ã‰xito","Usuario creado"); cerrarModalUsuario(); cargarUsuariosSelect(); } else ui.alertar("Error","No se pudo crear"); }

        function getColor(s) { return s==='Pendiente'?'#fbbf24':s==='En Proceso'?'#3b82f6':'#10b981'; }
        function logout() { localStorage.clear(); window.location.href='login.html'; }
        
        cargar();
    </script>
</body>
</html>
